'use strict';

module.exports = (middleware) => (req, res, next) => {
  const partitionedConfig = req.routerConfig && req.routerConfig.cookies && req.routerConfig.cookies['Partitioned'];
  if (partitionedConfig){
    const re = /;\s*Partitioned\s*(;|$)/i;
    const partitioned = ' Partitioned';
    const userAgent = req.headers['user-agent'] || '';
    const _setHeader = res.setHeader;
    if (userAgent.match(partitionedConfig.supportedPartitionAgents) && !userAgent.match(partitionedConfig.unsupportedPartitionAgents)) {
      res.setHeader = function (key, val) {
        return _setHeader.call(res, key, key && key.toLowerCase() === 'set-cookie' && Array.isArray(val) ?
          val.map(v => v.match(re) ? v : v + (v.endsWith(';') ? partitioned : ';' + partitioned)) :
          val
        );
      };
    }
  }
  return middleware(req, res, next);
};
